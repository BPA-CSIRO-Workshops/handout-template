\documentclass[a4paper,12pt,twoside]{memoir}
\let\footruleskip\undefined % see http://tex.stackexchange.com/questions/37868/fancyhdr-and-memoir
\usepackage{fancyhdr} % For headers and footers
\usepackage{listings} % Required for insertion of code
\usepackage{courier}  % Required for the courier font
\usepackage[usenames,dvipsnames]{color} % Required for custom colors
\usepackage[table]{xcolor}
\usepackage[pdftex]{graphicx}
\usepackage{hyperref}
\usepackage{fullpage} % See http://en.wikibooks.org/wiki/LaTeX/Page_Layout#Manual_Page_Formatting for layout
\usepackage{enumitem}
\linespread{1.0} % Line spacing
\setlength{\parindent}{0pt}
\setlength{\parskip}{0.2cm}
\usepackage{mdframed}
\usepackage{etoolbox}
\usepackage[nobottomtitles]{titlesec}
\usepackage[section]{placeins}

\usepackage{ifthen}
\usepackage{array}
% packages for Creative Commons Licences
\usepackage{xmpincl}
\includexmp{licences/CC_Attribution_3.0_Unported} % includes XML metadata into the PDF
\usepackage{microtype}
\usepackage{accsupp}
\usepackage{textcomp}
\usepackage{float}
\usepackage{lmodern}        % to ensure most charaters in listings and texttt are copy-paste safe and print nicely
\usepackage{comment}
\newtoggle{trainermanual}   % defaults to false

%%%%%%%%%%
%%%%%%%%%%
\settoggle{trainermanual}{true}  % Uncomment to generate the trainer's manual
%%%%%%%%%%
%%%%%%%%%%

\raggedbottom               % put all vertical white space at the bottom of the page 

\newlength{\defparskip}
\setlength{\defparskip}{0.5cm}
\specialcomment{answer}{\begingroup\color{red}}{\endgroup}

\newlength{\descriptionlabelspace}
\setlength{\descriptionlabelspace}{5.5cm}

% config display of hyperlinks
\hypersetup{
    colorlinks=true,        % false: boxed links; true: colored links
    linkcolor=red,          % color of internal links
    citecolor=green,        % color of links to bibliography
    filecolor=magenta,      % color of file links
    urlcolor=blue           % color of external links
}

\definecolor{darkgreen}{rgb}{0,0.9,0}
\newcommand{\noncopytext}[1]{%
    \BeginAccSupp{method=escape,ActualText={}}%
    #1%
    \EndAccSupp{}%
}
\lstset{ %
%    language=sh,                    % the language of the code
    columns=fullflexible,
    upquote=true,
    aboveskip=5pt,
    belowskip=10pt,
    basicstyle=\small\ttfamily,      % the size of the fonts that are used for the code
    numbers=left,                    % where to put the line-numbers
    numberstyle=\tiny\color{black!85}\noncopytext,  % the style that is used for the line-numbers
    stepnumber=1,                    % the step between two line-numbers. If it's 1, each line 
%                                    % will be numbered
    numbersep=13pt,                  % how far the line-numbers are from the code. Add framesep value to this
    backgroundcolor=\color{black!5}, % choose the background color. You must add \usepackage{color}
    showspaces=false,                % show spaces adding particular underscores
    showstringspaces=false,          % underline spaces within strings
    showtabs=false,                  % show tabs within strings adding particular underscores
    xleftmargin=20pt,
    xrightmargin=10pt,
    framesep=5pt,
    framerule=3pt,
    frame=leftline,                  % adds a frame around the code
    rulecolor=\color{darkgreen},     % if not set, the frame-color may be changed on line-breaks within not-black text (e.g. commens (green here))
    tabsize=2,                       % sets default tabsize to 2 spaces
    breaklines=true,                 % sets automatic line breaking
    breakatwhitespace=true,          % sets if automatic breaks should only happen at whitespace
    breakindent=20pt,
    breakautoindent=true,
    prebreak=\small\symbol{'134},
    literate=%{*}{{\textasteriskcentered}}{1}
             {~}{{\texttildelow}}{1} % reformat the high tilde to a normal tile which looks good for printing and is copy-and-pastable
             %{-}{{\textminus}}{1},
}

% disables chapter, section and subsection numbering
% and number figures and tables consecutively throughout the document
\setcounter{secnumdepth}{-1}
\counterwithout{figure}{chapter}
\counterwithout{table}{chapter}


% This allows stuff on the same line to be vertically centered with respect of each other
\def\vcent#1{\mathsurround0pt$\vcenter{\hbox{#1}}$}
\def\vtp#1{\mathsurround0pt$\vtop{\hbox{#1}}$}

% config ...
\setlength{\topskip}{0.75cm}
\definecolor{warningshade}{rgb}{1,0.85,0.85}
\definecolor{questionshade}{rgb}{1,0.95,0.85}
\definecolor{bonusshade}{rgb}{0.92,1,0.92}
\definecolor{advancedshade}{rgb}{0.92,0.92,1}

% defaine a default style for the mdframed-based environments
% TODO Figure out how to apply the default style as the basis for other styles
\global\mdfdefinestyle{default}{
  leftmargin=0pt,
  skipabove=5pt,
  rightmargin=0pt,
  skipbelow=10pt,
  %splittopskip=0pt,
  %splitbottomskip=0pt,
  innermargin=0pt,
  outermargin=0pt,
  innerleftmargin=0pt,
  innerrightmargin=0pt,
  innertopmargin=0pt,
  innerbottommargin=0pt,
  leftline=false,
  topline=false,
  rightline=false,
  bottomline=false,
  linecolor=black,
  linewidth=1pt,
  roundcorner=5pt,
}

\global\mdfdefinestyle{warningbox}{
  leftmargin=0pt,
  skipabove=5pt,
  rightmargin=0pt,
  skipbelow=10pt,
  %splittopskip=0pt,
  %splitbottomskip=0pt,
  innermargin=0pt,
  outermargin=0pt,
  innerleftmargin=0pt,
  innerrightmargin=0pt,
  innertopmargin=0pt,
  innerbottommargin=0pt,
  leftline=false,
  topline=false,
  rightline=false,
  bottomline=false,
  linecolor=black,
  linewidth=1pt,
  roundcorner=5pt,
  backgroundcolor=warningshade,
  leftline=true,
  topline=true,
  rightline=true,
  bottomline=true,
  innerleftmargin=10pt,
  innerrightmargin=10pt,
  innertopmargin=10pt,
  innerbottommargin=10pt,
  nobreak=true,
}
\global\mdfdefinestyle{questionsbox}{
  leftmargin=0pt,
  skipabove=5pt,
  rightmargin=0pt,
  skipbelow=10pt,
  %splittopskip=0pt,
  %splitbottomskip=0pt,
  innermargin=0pt,
  outermargin=0pt,
  innerleftmargin=0pt,
  innerrightmargin=0pt,
  innertopmargin=0pt,
  innerbottommargin=0pt,
  leftline=false,
  topline=false,
  rightline=false,
  bottomline=false,
  linecolor=black,
  linewidth=1pt,
  roundcorner=5pt,
  backgroundcolor=questionshade,
  leftline=true,
  topline=true,
  rightline=true,
  bottomline=true,
  innerleftmargin=10pt,
  innerrightmargin=10pt,
  innertopmargin=10pt,
  innerbottommargin=10pt,
  skipabove=15pt,
  skipbelow=20pt,
  nobreak=true,
}
\global\mdfdefinestyle{bonusbox}{
  leftmargin=0pt,
  skipabove=5pt,
  rightmargin=0pt,
  skipbelow=10pt,
  %splittopskip=0pt,
  %splitbottomskip=0pt,
  innermargin=0pt,
  outermargin=0pt,
  innerleftmargin=0pt,
  innerrightmargin=0pt,
  innertopmargin=0pt,
  innerbottommargin=0pt,
  leftline=false,
  topline=false,
  rightline=false,
  bottomline=false,
  linecolor=black,
  linewidth=1pt,
  roundcorner=5pt,
%  backgroundcolor=bonusshade,
  leftline=true,
  topline=true,
  rightline=true,
  bottomline=true,
  innerleftmargin=10pt,
  innerrightmargin=10pt,
  innertopmargin=10pt,
  innerbottommargin=10pt,
  skipabove=15pt,
  skipbelow=20pt,
  nobreak=false,                % these could span multiple pages, so we should let them break across pages
}
\global\mdfdefinestyle{advancedbox}{
  leftmargin=0pt,
  skipabove=5pt,
  rightmargin=0pt,
  skipbelow=10pt,
  %splittopskip=0pt,
  %splitbottomskip=0pt,
  innermargin=0pt,
  outermargin=0pt,
  innerleftmargin=0pt,
  innerrightmargin=0pt,
  innertopmargin=0pt,
  innerbottommargin=0pt,
  leftline=false,
  topline=false,
  rightline=false,
  bottomline=false,
  linecolor=black,
  linewidth=1pt,
  roundcorner=5pt,
%  backgroundcolor=advancedshade,
  leftline=true,
  topline=true,
  rightline=true,
  bottomline=true,
  innerleftmargin=10pt,
  innerrightmargin=10pt,
  innertopmargin=10pt,
  innerbottommargin=10pt,
  skipabove=15pt,
  skipbelow=20pt,
  nobreak=false,                % these could span multiple pages, so we should let them break across pages
}

\newlength{\iconspacinglength}
\setlength{\iconspacinglength}{0.5cm}
\newcommand{\iconspacing}{\iconspacinglength}
\newlength{\questionspacing}
\setlength{\questionspacing}{2cm}


\newenvironment{steps}{%
\begin{mdframed}[style=default]%
%\addtolength{\iconspacinglength}{\mdflength{leftmargin}}%
%\addtolength{\iconspacinglength}{\mdflength{innerleftmargin}}%
\makebox[0pt][r]{\smash{\raisebox{-.6\height}{%
\includegraphics[height=1cm]{./graphics/steps.png}%
\hspace{\iconspacinglength}%
}}}\ignorespaces%
}%
{%
\end{mdframed}%
}

\newenvironment{bonus}{%
\begin{mdframed}[style=bonusbox]%
\addtolength{\iconspacinglength}{\mdflength{leftmargin}}%
\addtolength{\iconspacinglength}{\mdflength{innerleftmargin}}%
%\newpage%
\makebox[0pt][r]{\smash{\raisebox{-.6\height}{%
\includegraphics[height=1cm]{./graphics/bonus1.png}%
\hspace{\iconspacinglength}%
}%
}%
}\ignorespaces%\vspace{-3em}\vspace{-\parskip}%
}%
{%
\end{mdframed}%
}
  
\newenvironment{advanced}{%
\begin{mdframed}[style=advancedbox]%
\addtolength{\iconspacinglength}{\mdflength{leftmargin}}%
\addtolength{\iconspacinglength}{\mdflength{innerleftmargin}}%
%\newpage%
\makebox[0pt][r]{\smash{\raisebox{-.6\height}{%
\includegraphics[height=1cm]{./graphics/bonus2.png}%
\hspace{\iconspacinglength}%
}%
}%
}\ignorespaces%\vspace{-3em}%
}%
{%
\end{mdframed}%
}

\newenvironment{information}{%
\begin{mdframed}[style=default]%
%\addtolength{\iconspacinglength}{\mdflength{leftmargin}}%
%\addtolength{\iconspacinglength}{\mdflength{innerleftmargin}}%
\makebox[0pt][r]{\smash{\raisebox{-.6\height}{%
\includegraphics[height=1cm]{./graphics/info.png}%
\hspace{\iconspacinglength}%
}}}\ignorespaces%
}%
{%
\end{mdframed}%
}

\newenvironment{note}{%
\begin{mdframed}[style=default]%
%\addtolength{\iconspacinglength}{\mdflength{leftmargin}}%
%\addtolength{\iconspacinglength}{\mdflength{innerleftmargin}}%
\makebox[0pt][r]{\smash{\raisebox{-.6\height}{%
\includegraphics[height=1cm]{./graphics/notes.png}%
\hspace{\iconspacinglength}%
}}}\ignorespaces%
}%
{%
\end{mdframed}%
}

\newenvironment{warning}{%
\begin{mdframed}[style=warningbox]%
\addtolength{\iconspacinglength}{\mdflength{leftmargin}}%
\addtolength{\iconspacinglength}{\mdflength{innerleftmargin}}%
\makebox[0pt][r]{\smash{\raisebox{-.25\height}{%
\includegraphics[height=1cm]{./graphics/warning.png}%
\hspace{\iconspacinglength}%
}}}\ignorespaces%
}%
{%
\end{mdframed}%
}

\newenvironment{questions}{%
\begin{mdframed}[style=questionsbox]%
\nottoggle{trainermanual}{\setlength{\parskip}{\questionspacing}}{}%
\addtolength{\iconspacinglength}{\mdflength{leftmargin}}%
\addtolength{\iconspacinglength}{\mdflength{innerleftmargin}}%
\makebox[0pt][r]{\smash{\raisebox{-.25\height}{%
\includegraphics[height=1cm]{./graphics/questions.png}%
\hspace{\iconspacinglength}%
}}}\ignorespaces%
}%
{%
\nottoggle{trainermanual}{\vspace{\questionspacing}}{}%
\end{mdframed}%
}

\definecolor{trainerfrontpageshade}{rgb}{1,0.9,0.9}
\newcommand{\trainermanualtext}{\huge\textbf{\textcolor{red}{TRAINER'S MANUAL}}}


\newcommand{\workshoptitlepage}{
\thispagestyle{plain}
\iftoggle{trainermanual}{
\pagecolor{trainerfrontpageshade}
}{}
\noindent

\begin{center}
\rule{\textwidth}{1pt}

\vspace*{\fill}
{\Huge\workshopTitle}
\vspace{2cm}

\workshopAuthor

\vfill

\rule{\textwidth}{1pt}
\begin{minipage}{0.45\textwidth}
\begin{flushleft}
\workshopVenue
\end{flushleft}
\end{minipage}
\begin{minipage}{0.45\textwidth}
\begin{flushright}
\workshopDate
\end{flushright}
\end{minipage}
\rule{\textwidth}{1pt}
\end{center}
\clearpage
\iftoggle{trainermanual}{
\pagecolor{white}%
}{}
}

%TODO Revise this chapter styling code, there appears to be a couple of things wrong with it.
\makechapterstyle{workshop}{%
  \chapterstyle{default}
  \renewcommand*{\chapnumfont}{\normalfont\HUGE\sffamily}
  \renewcommand*{\chaptitlefont}{\normalfont\huge\sffamily}
  \settowidth{\chapindent}{\chapnumfont 111}
  \renewcommand*{\chapterheadstart}{\begingroup
    %\vspace*{\beforechapskip}%
    \begin{adjustwidth}{}{-\chapindent}%
    \hrulefill
    \smash{\rule{0.4pt}{15mm}}
    \end{adjustwidth}\endgroup}
  \renewcommand*{\printchaptername}{}
  \renewcommand*{\chapternamenum}{}
  \renewcommand*{\printchapternum}{%
    \begin{adjustwidth}{}{-\chapindent}
    \hfill
    \raisebox{10mm}[0pt][0pt]{\chapnumfont \thechapter}%
                              \hspace*{1em}
    \end{adjustwidth}\vspace*{-3.0\onelineskip}}
  \renewcommand*{\printchaptertitle}[1]{%
    \vskip\onelineskip
    \raggedleft {\chaptitlefont ##1}\par\nobreak}
  
}
\makechapterstyle{module}{%
  \chapterstyle{workshop}
  \renewcommand*{\printchaptertitle}[1]{%
    \vskip\onelineskip
    \raggedleft {\chaptitlefont Module: ##1}\par\nobreak
    \vspace{\vfill}
    Primary Author(s):\par
    \moduleAuthors\par
    \vspace{1cm}
    Contributor(s):\par
    \moduleContributions}\par
}
\aliaspagestyle{chapter}{empty}
\newcommand{\mailto}[1]{
\href{mailto:#1}{\nolinkurl{#1}}
}

\newcommand{\moduleTitle}{}
\newcommand{\moduleAuthors}{}
\newcommand{\moduleContributions}{}

%\newcolumntype{V}{>{\centering\arraybackslash} m{3cm} }


% set default headers footers
\pagestyle{fancy}
\setlength{\headheight}{15pt}
\fancyhead[LE,RO]{\slshape \nouppercase{\leftmark}}
\fancyhead[LO,RE]{\slshape \nouppercase{\rightmark}}
\fancyfoot[LE,RO]{\thepage}
\fancyfoot[C]{}
\addtolength{\headsep}{\baselineskip} 
\iftoggle{trainermanual}{
\fancyfoot[C]{\trainermanualtext}
}{}

% define the plain page style for both trainee and trainer's manual
\fancypagestyle{plain}{%
\fancyhf{} % clear all header and footer fields
\renewcommand{\headrulewidth}{0pt}
}
\iftoggle{trainermanual}{
\fancypagestyle{plain}{%
\fancyhf{}
\fancyhead[C]{\trainermanualtext}
\fancyfoot[C]{\trainermanualtext}
\renewcommand{\headrulewidth}{0pt}
}{}
}


\title{\workshopTitle}
\date{\workshopDate}
\author{\workshopAuthor}


\nottoggle{trainermanual}{
\excludecomment{answer}
}{}

%\includeonly{workshop_preamble.tex,rna-seq.tex}

\chapterstyle{workshop}

% Code for making a page run of ruled lines. From:
% http://tex.stackexchange.com/a/79018/19412
% Defines \myruledpage command with two mandatory arguments; the first one gives
% the length of the first column of rules, and the second one controls the
% separation between rules;
\makeatletter
% Code taken from exam.cls and modified
\newlength\linefillheight
\newlength\linefillthickness
\setlength\linefillheight{.25in}
\setlength\linefillthickness{0.1pt}
\newcommand\linefill[1]{\leavevmode
    \rule{#1}{\linefillthickness}\ \leaders\hrule height \linefillthickness \hfill\kern\z@}
\newcommand\fillwithlines[2]{%
  \begingroup
  \ifhmode
    \par
  \fi
  \hrule height \z@
  \nobreak
  \setbox0=\hbox to \hsize{\hskip \@totalleftmargin
          \vrule height \linefillheight depth \z@ width \z@
          \linefill{#2}}%
  % We use \cleaders (rather than \leaders) so that a given
  % vertical space will always produce the same number of lines
  % no matter where on the page it happens to start:
  \cleaders \copy0 \vskip #1 \hbox{}%
  \endgroup
}
\makeatother
\newcommand\myruledpage[2]{%
  \setlength\linefillheight{#2}
  \fillwithlines{\stretch{1}}{#1}
\newpage}


%%%%%%%%%%
%%%%%%%%%%


%
% User Defined Workshop Details
%
\newcommand{\workshopTitle}{Example Workshop Title}
\newcommand{\workshopVenue}{Example Location, Earth}
\newcommand{\workshopDate}{MMM. YYYY}
\newcommand{\workshopAuthor}{
Example Workshop Author, Contributers etc\\
}


%
% Example Workshop Handout with title page and a section domonstrating
% the different environments defined in the top matter
%
\begin{document}

%
% Workshop Title Page
%
\workshoptitlepage


\section{Example Section Heading}

\begin{information}
Information to be provided to the trainee.
\end{information}

\begin{steps}
Instructions for the trainee to perform.
\end{steps}

\begin{note}
Something of note.
\end{note}

\begin{warning}
A warning to the trainee which needs to be read carefully.
\end{warning}

\begin{questions}
First question.
\begin{answer}
Answer to first question.
\end{answer}

Second question.
\begin{answer}
Answer to second question.
\end{answer}
\end{questions}

\begin{bonus}
An optional bonus section for those progressing rapidly.
\end{bonus}

\begin{advanced}
An optional advanced section for those progressing very rapidly or to be used for future reference.
\end{advanced}

\begin{lstlisting}
# several lines of code
cd ~/
ls -l
# a long command that line wraps automatically
tophat --solexa-quals -g 2 --library-type fr-unstranded -j annotation/Danio_rerio.Zv9.66.spliceSites -o tophat/ZV9_2cells genome/ZV9 data/2cells_1.fastq data/2cells_2.fastq
\end{lstlisting}

\end{document}
